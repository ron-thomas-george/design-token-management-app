<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Design Token Sync</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f8f9fa;
      color: #333;
      font-size: 13px;
    }
    
    .container {
      max-width: 100%;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #e1e5e9;
    }
    
    .section h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .input-group {
      margin-bottom: 10px;
    }
    
    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #555;
    }
    
    .input-group input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #0066cc;
    }
    
    .button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 6px;
      transition: background-color 0.2s;
      box-sizing: border-box;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .button:hover {
      background: #0052a3;
    }
    
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #6c757d;
    }
    
    .button.secondary:hover {
      background: #5a6268;
    }
    
    .button.success {
      background: #28a745;
    }
    
    .button.success:hover {
      background: #218838;
    }
    
    .button.warning {
      background: #ffc107;
      color: #212529;
    }
    
    .button.warning:hover {
      background: #e0a800;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .button-row .button {
      flex: 1;
      margin-bottom: 0;
    }
    
    .button.import {
      background: #17a2b8;
    }
    
    .button.import:hover {
      background: #138496;
    }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      font-size: 12px;
      margin-bottom: 10px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-dot.connected {
      background: #28a745;
    }
    
    .status-dot.disconnected {
      background: #dc3545;
    }
    
    .status-dot.warning {
      background: #ffc107;
    }
    
    .token-stats {
      display: flex;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 11px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-weight: 600;
      font-size: 14px;
      color: #0066cc;
    }
    
    .stat-label {
      color: #666;
      margin-top: 2px;
    }
    
    .changes-summary {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .changes-summary h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #856404;
    }
    
    .change-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    
    .hidden {
      display: none;
    }
    
    .collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible:hover {
      background: #f8f9fa;
    }
    
    .config-form {
      display: none;
    }
    
    .config-form.active {
      display: block;
    }
    
    .toggle-text {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Design Token Sync</h1>
    
    
    <!-- Connection Status -->
    <div class="section">
      <h2>Connection Status</h2>
      <div class="connection-status">
        <div class="status-dot disconnected" id="statusDot"></div>
        <span id="statusText">Not connected</span>
      </div>
      <div id="connectionDetails" class="hidden"></div>
    </div>
    
    <!-- Token Statistics -->
    <div class="section" id="statsSection" style="display: none;">
      <h2>Token Overview</h2>
      <div class="token-stats">
        <div class="stat-item">
          <div class="stat-number" id="totalTokens">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="addedTokens">0</div>
          <div class="stat-label">Added</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="modifiedTokens">0</div>
          <div class="stat-label">Modified</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="deletedTokens">0</div>
          <div class="stat-label">Deleted</div>
        </div>
      </div>
    </div>
    
    <!-- Changes Summary -->
    <div id="changesSummary" class="changes-summary hidden">
      <h3>üìã Detected Changes</h3>
      <div id="changesContent"></div>
    </div>
    
    <!-- Actions -->
    <div class="section">
      <h2>Actions</h2>
      <div style="margin-bottom: 8px;">
        <button class="button" id="fetchBtn">üì• Fetch Latest Tokens</button>
      </div>
      <div style="margin-bottom: 8px;">
        <button class="button warning" id="checkChangesBtn" disabled>üîç Check Changes</button>
      </div>
      <div class="button-row" style="margin-top: 8px;">
        <button class="button import" id="importBtn" disabled>üöÄ Import All</button>
        <button class="button" id="variablesBtn" disabled>üìê Create Variables</button>
      </div>
    </div>
    
    <!-- Status Messages -->
    <div id="statusMessage"></div>
    
    <!-- Close -->
    <div class="section">
      <button class="button secondary" id="closeBtn">Close Plugin</button>
    </div>
  </div>

  <script>
    let tokens = [];
    let currentChanges = null;
    let isSupabaseConfigured = false;
    
    // DOM elements
    const fetchBtn = document.getElementById('fetchBtn');
    const checkChangesBtn = document.getElementById('checkChangesBtn');
    const importBtn = document.getElementById('importBtn');
    const variablesBtn = document.getElementById('variablesBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const connectionDetails = document.getElementById('connectionDetails');
    const statsSection = document.getElementById('statsSection');
    const changesSummary = document.getElementById('changesSummary');
    const changesContent = document.getElementById('changesContent');
    
    // Event listeners
    fetchBtn.addEventListener('click', fetchTokens);
    checkChangesBtn.addEventListener('click', checkChanges);
    importBtn.addEventListener('click', importTokens);
    variablesBtn.addEventListener('click', createVariablesOnly);
    closeBtn.addEventListener('click', closePlugin);
    
    
    // Fetch tokens
    function fetchTokens() {
      showStatus('Fetching tokens...', 'info');
      fetchBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'fetch-tokens' } }, '*');
    }
    
    // Check for changes
    function checkChanges() {
      showStatus('Checking for changes...', 'info');
      checkChangesBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'check-changes' } }, '*');
    }
    
    
    // Import all tokens (variables + visualization)
    function importTokens() {
      if (tokens.length === 0) {
        showStatus('No tokens to import', 'error');
        return;
      }
      
      showStatus('Creating variables and visualization...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'import-tokens', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Create variables only
    function createVariablesOnly() {
      if (tokens.length === 0) {
        showStatus('No tokens to create variables from', 'error');
        return;
      }
      
      showStatus('Creating Figma variables...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables-only', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Close plugin
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }
    
    // Show status message
    function showStatus(message, type = 'info') {
      statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Update connection status
    function updateConnectionStatus(connected, details = '', type = 'info') {
      const dotClass = type === 'warning' ? 'warning' : (connected ? 'connected' : 'disconnected');
      statusDot.className = `status-dot ${dotClass}`;
      
      if (isSupabaseConfigured) {
        statusText.textContent = connected ? 'Connected to Supabase' : 'Supabase connection failed';
      } else {
        statusText.textContent = connected ? 'Connected via API' : 'Not connected';
      }
      
      if (details) {
        connectionDetails.textContent = details;
        connectionDetails.classList.remove('hidden');
      } else {
        connectionDetails.classList.add('hidden');
      }
    }
    
    // Update token statistics
    function updateStats(totalTokens, changes = null) {
      document.getElementById('totalTokens').textContent = totalTokens;
      
      if (changes) {
        document.getElementById('addedTokens').textContent = changes.added.length;
        document.getElementById('modifiedTokens').textContent = changes.modified.length;
        document.getElementById('deletedTokens').textContent = changes.deleted.length;
      } else {
        document.getElementById('addedTokens').textContent = '0';
        document.getElementById('modifiedTokens').textContent = '0';
        document.getElementById('deletedTokens').textContent = '0';
      }
      
      statsSection.style.display = 'block';
    }
    
    // Update changes summary
    function updateChangesSummary(changes) {
      if (!changes || (changes.added.length === 0 && changes.modified.length === 0 && changes.deleted.length === 0)) {
        changesSummary.classList.add('hidden');
        return;
      }
      
      let html = '';
      
      if (changes.added.length > 0) {
        html += `<div class="change-item"><span>‚ûï Added:</span><span>${changes.added.length}</span></div>`;
      }
      
      if (changes.modified.length > 0) {
        html += `<div class="change-item"><span>‚úèÔ∏è Modified:</span><span>${changes.modified.length}</span></div>`;
      }
      
      if (changes.deleted.length > 0) {
        html += `<div class="change-item"><span>üóëÔ∏è Deleted:</span><span>${changes.deleted.length}</span></div>`;
      }
      
      changesContent.innerHTML = html;
      changesSummary.classList.remove('hidden');
    }
    
    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'plugin-ready') {
        showStatus('Plugin ready', 'info');
      }
      
      if (msg.type === 'supabase-auto-configured') {
        if (msg.success) {
          showStatus('Connected to Supabase automatically', 'success');
          updateConnectionStatus(true, 'Supabase connection active');
        } else {
          showStatus('Using API fallback mode', 'info');
          updateConnectionStatus(true, 'API fallback active');
        }
      }
      
      if (msg.type === 'supabase-configured') {
        if (msg.success) {
          isSupabaseConfigured = true;
          showStatus(`Supabase connected! Found ${msg.tokenCount} tokens`, 'success');
          updateConnectionStatus(true, `${msg.tokenCount} tokens available`, 'success');
        } else {
          showStatus(`Supabase connection failed: ${msg.error}`, 'error');
          updateConnectionStatus(false, msg.error, 'error');
        }
      }
      
      if (msg.type === 'tokens-fetched') {
        tokens = msg.tokens || [];
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = tokens.length === 0;
        variablesBtn.disabled = tokens.length === 0;
        
        updateConnectionStatus(true, `${tokens.length} tokens loaded`);
        updateStats(tokens.length);
        showStatus(`Fetched ${tokens.length} tokens successfully`, 'success');
      }
      
      if (msg.type === 'changes-detected') {
        currentChanges = msg.changes;
        checkChangesBtn.disabled = false;
        
        updateStats(msg.totalTokens, msg.changes);
        updateChangesSummary(msg.changes);
        
        const changeCount = (msg.changes.added.length + msg.changes.modified.length + msg.changes.deleted.length);
        if (changeCount > 0) {
          showStatus(`Found ${changeCount} changes`, 'warning');
        } else {
          showStatus('No changes detected', 'success');
        }
      }
      
      
      if (msg.type === 'success') {
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        showStatus(msg.message, 'success');
      }
      
      if (msg.type === 'error') {
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        updateConnectionStatus(false, msg.error || msg.message);
        showStatus(msg.error || msg.message, 'error');
      }
    };
    
    // Initialize
    showStatus('Ready to connect', 'info');
  </script>
</body>
</html>
