<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fragmento Sync</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #2c2c2c;
      color: #ffffff;
      font-size: 13px;
    }
    
    .container {
      max-width: 100%;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section {
      background: #3a3a3a;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #4a4a4a;
    }
    
    .section h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: #ffffff;
    }
    
    .input-group {
      margin-bottom: 10px;
    }
    
    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #cccccc;
    }
    
    .input-group input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
      background: #2c2c2c;
      color: #ffffff;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #3ecf8e;
    }
    
    .button {
      background: #3ecf8e;
      color: #000000;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 6px;
      transition: background-color 0.2s;
      box-sizing: border-box;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .button:hover {
      background: #2dd4aa;
    }
    
    .button:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #4a4a4a;
      color: #ffffff;
    }
    
    .button.secondary:hover {
      background: #5a5a5a;
    }
    
    .button.success {
      background: #3ecf8e;
      color: #000000;
    }
    
    .button.success:hover {
      background: #2dd4aa;
    }
    
    .button.warning {
      background: #f59e0b;
      color: #000000;
    }
    
    .button.warning:hover {
      background: #d97706;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .button-row .button {
      flex: 1;
      margin-bottom: 0;
    }
    
    .button.import {
      background: #06b6d4;
      color: #000000;
    }
    
    .button.import:hover {
      background: #0891b2;
    }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .status.success {
      background: #3ecf8e20;
      color: #3ecf8e;
      border: 1px solid #3ecf8e40;
    }
    
    .status.error {
      background: #ef444420;
      color: #ef4444;
      border: 1px solid #ef444440;
    }
    
    .status.info {
      background: #06b6d420;
      color: #06b6d4;
      border: 1px solid #06b6d440;
    }
    
    .status.warning {
      background: #f59e0b20;
      color: #f59e0b;
      border: 1px solid #f59e0b40;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      font-size: 12px;
      margin-bottom: 10px;
      color: #cccccc;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-dot.connected {
      background: #3ecf8e;
    }
    
    .status-dot.disconnected {
      background: #ef4444;
    }
    
    .status-dot.warning {
      background: #f59e0b;
    }
    
    .token-stats {
      display: flex;
      justify-content: space-between;
      background: #3a3a3a;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 11px;
      border: 1px solid #4a4a4a;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-weight: 600;
      font-size: 14px;
      color: #3ecf8e;
    }
    
    .stat-label {
      color: #cccccc;
      margin-top: 2px;
    }
    
    .changes-summary {
      background: #f59e0b20;
      border: 1px solid #f59e0b40;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .changes-summary h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #f59e0b;
    }
    
    .change-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      color: #cccccc;
    }
    
    .hidden {
      display: none;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .button-minimal {
      background: transparent;
      border: 1px solid #4a4a4a;
      color: #cccccc;
      padding: 12px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-height: 60px;
    }
    
    .button-minimal:hover:not(:disabled) {
      background: #3a3a3a;
      border-color: #3ecf8e;
      color: #ffffff;
    }
    
    .button-minimal:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .button-icon {
      font-size: 16px;
      line-height: 1;
    }
    
    .button-text {
      font-size: 10px;
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
    }
    
    .collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible:hover {
      background: #4a4a4a;
    }
    
    .config-form {
      display: none;
    }
    
    .config-form.active {
      display: block;
    }
    
    .toggle-text {
      font-size: 11px;
      color: #cccccc;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Fragmento Sync</h1>
    
    
    <!-- Connection Status -->
    <div class="section">
      <h2>Connection Status</h2>
      <div class="connection-status">
        <div class="status-dot disconnected" id="statusDot"></div>
        <span id="statusText">Not connected</span>
      </div>
      <div id="connectionDetails" class="hidden"></div>
    </div>
    
    <!-- Token Statistics -->
    <div class="section" id="statsSection" style="display: none;">
      <h2>Token Overview</h2>
      <div class="token-stats">
        <div class="stat-item">
          <div class="stat-number" id="totalTokens">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="addedTokens">0</div>
          <div class="stat-label">Added</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="modifiedTokens">0</div>
          <div class="stat-label">Modified</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="deletedTokens">0</div>
          <div class="stat-label">Deleted</div>
        </div>
      </div>
    </div>
    
    <!-- Changes Summary -->
    <div id="changesSummary" class="changes-summary hidden">
      <h3>üìã Detected Changes</h3>
      <div id="changesContent"></div>
    </div>
    
    <!-- Actions -->
    <div class="section">
      <h2>Actions</h2>
      <div class="action-grid">
        <button class="button-minimal" id="fetchBtn">
          <span class="button-icon">üì•</span>
          <span class="button-text">Fetch Tokens</span>
        </button>
        <button class="button-minimal" id="checkChangesBtn" disabled>
          <span class="button-icon">üîç</span>
          <span class="button-text">Check Changes</span>
        </button>
        <button class="button-minimal" id="importBtn" disabled>
          <span class="button-icon">üöÄ</span>
          <span class="button-text">Import All</span>
        </button>
        <button class="button-minimal" id="variablesBtn" disabled>
          <span class="button-icon">üìê</span>
          <span class="button-text">Create Variables</span>
        </button>
      </div>
    </div>
    
    <!-- Status Messages -->
    <div id="statusMessage"></div>
    
    <!-- Close -->
    <div class="section">
      <button class="button secondary" id="closeBtn">Close Plugin</button>
    </div>
  </div>

  <script>
    let tokens = [];
    let currentChanges = null;
    let isSupabaseConfigured = false;
    
    // DOM elements
    const fetchBtn = document.getElementById('fetchBtn');
    const checkChangesBtn = document.getElementById('checkChangesBtn');
    const importBtn = document.getElementById('importBtn');
    const variablesBtn = document.getElementById('variablesBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const connectionDetails = document.getElementById('connectionDetails');
    const statsSection = document.getElementById('statsSection');
    const changesSummary = document.getElementById('changesSummary');
    const changesContent = document.getElementById('changesContent');
    
    // Event listeners
    fetchBtn.addEventListener('click', fetchTokens);
    checkChangesBtn.addEventListener('click', checkChanges);
    importBtn.addEventListener('click', importTokens);
    variablesBtn.addEventListener('click', createVariablesOnly);
    closeBtn.addEventListener('click', closePlugin);
    
    
    // Fetch tokens
    function fetchTokens() {
      showStatus('Fetching tokens...', 'info');
      fetchBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'fetch-tokens' } }, '*');
    }
    
    // Check for changes
    function checkChanges() {
      showStatus('Checking for changes...', 'info');
      checkChangesBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'check-changes' } }, '*');
    }
    
    
    // Import all tokens (variables + visualization)
    function importTokens() {
      if (tokens.length === 0) {
        showStatus('No tokens to import', 'error');
        return;
      }
      
      showStatus('Creating variables and visualization...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'import-tokens', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Create variables only
    function createVariablesOnly() {
      if (tokens.length === 0) {
        showStatus('No tokens to create variables from', 'error');
        return;
      }
      
      showStatus('Creating Figma variables...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables-only', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Close plugin
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }
    
    // Show status message
    function showStatus(message, type = 'info') {
      statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Update connection status
    function updateConnectionStatus(connected, details = '', type = 'info') {
      const dotClass = type === 'warning' ? 'warning' : (connected ? 'connected' : 'disconnected');
      statusDot.className = `status-dot ${dotClass}`;
      
      if (isSupabaseConfigured) {
        statusText.textContent = connected ? 'Connected to Supabase' : 'Supabase connection failed';
      } else {
        statusText.textContent = connected ? 'Connected via API' : 'Not connected';
      }
      
      if (details) {
        connectionDetails.textContent = details;
        connectionDetails.classList.remove('hidden');
      } else {
        connectionDetails.classList.add('hidden');
      }
    }
    
    // Update token statistics
    function updateStats(totalTokens, changes = null) {
      document.getElementById('totalTokens').textContent = totalTokens;
      
      if (changes) {
        document.getElementById('addedTokens').textContent = changes.added.length;
        document.getElementById('modifiedTokens').textContent = changes.modified.length;
        document.getElementById('deletedTokens').textContent = changes.deleted.length;
      } else {
        document.getElementById('addedTokens').textContent = '0';
        document.getElementById('modifiedTokens').textContent = '0';
        document.getElementById('deletedTokens').textContent = '0';
      }
      
      statsSection.style.display = 'block';
    }
    
    // Update changes summary
    function updateChangesSummary(changes) {
      if (!changes || (changes.added.length === 0 && changes.modified.length === 0 && changes.deleted.length === 0)) {
        changesSummary.classList.add('hidden');
        return;
      }
      
      let html = '';
      
      if (changes.added.length > 0) {
        html += `<div class="change-item"><span>‚ûï Added:</span><span>${changes.added.length}</span></div>`;
      }
      
      if (changes.modified.length > 0) {
        html += `<div class="change-item"><span>‚úèÔ∏è Modified:</span><span>${changes.modified.length}</span></div>`;
      }
      
      if (changes.deleted.length > 0) {
        html += `<div class="change-item"><span>üóëÔ∏è Deleted:</span><span>${changes.deleted.length}</span></div>`;
      }
      
      changesContent.innerHTML = html;
      changesSummary.classList.remove('hidden');
    }
    
    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'plugin-ready') {
        showStatus('Plugin ready', 'info');
      }
      
      if (msg.type === 'supabase-auto-configured') {
        if (msg.success) {
          showStatus('Connected to Supabase automatically', 'success');
          updateConnectionStatus(true, 'Supabase connection active');
        } else {
          showStatus('Using API fallback mode', 'info');
          updateConnectionStatus(true, 'API fallback active');
        }
      }
      
      if (msg.type === 'supabase-configured') {
        if (msg.success) {
          isSupabaseConfigured = true;
          showStatus(`Supabase connected! Found ${msg.tokenCount} tokens`, 'success');
          updateConnectionStatus(true, `${msg.tokenCount} tokens available`, 'success');
        } else {
          showStatus(`Supabase connection failed: ${msg.error}`, 'error');
          updateConnectionStatus(false, msg.error, 'error');
        }
      }
      
      if (msg.type === 'tokens-fetched') {
        tokens = msg.tokens || [];
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = tokens.length === 0;
        variablesBtn.disabled = tokens.length === 0;
        
        updateConnectionStatus(true, `${tokens.length} tokens loaded`);
        updateStats(tokens.length);
        showStatus(`Fetched ${tokens.length} tokens successfully`, 'success');
      }
      
      if (msg.type === 'changes-detected') {
        currentChanges = msg.changes;
        checkChangesBtn.disabled = false;
        
        updateStats(msg.totalTokens, msg.changes);
        updateChangesSummary(msg.changes);
        
        const changeCount = (msg.changes.added.length + msg.changes.modified.length + msg.changes.deleted.length);
        if (changeCount > 0) {
          showStatus(`Found ${changeCount} changes`, 'warning');
        } else {
          showStatus('No changes detected', 'success');
        }
      }
      
      
      if (msg.type === 'success') {
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        showStatus(msg.message, 'success');
      }
      
      if (msg.type === 'error') {
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        updateConnectionStatus(false, msg.error || msg.message);
        showStatus(msg.error || msg.message, 'error');
      }
    };
    
    // Initialize
    showStatus('Ready to connect', 'info');
  </script>
</body>
</html>
