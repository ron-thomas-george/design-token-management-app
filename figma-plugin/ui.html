<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fragmento Sync</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #2c2c2c;
      color: #ffffff;
      font-size: 13px;
    }
    
    .container {
      max-width: 100%;
    }
    
    h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section {
      background: #3a3a3a;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #4a4a4a;
    }
    
    .section h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: #ffffff;
    }
    
    .input-group {
      margin-bottom: 10px;
    }
    
    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #cccccc;
    }
    
    .input-group input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
      background: #2c2c2c;
      color: #ffffff;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #3ecf8e;
    }
    
    .button {
      background: #3ecf8e;
      color: #000000;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 6px;
      transition: background-color 0.2s;
      box-sizing: border-box;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .button:hover {
      background: #2dd4aa;
    }
    
    .button:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #4a4a4a;
      color: #ffffff;
    }
    
    .button.secondary:hover {
      background: #5a5a5a;
    }
    
    .button.success {
      background: #3ecf8e;
      color: #000000;
    }
    
    .button.success:hover {
      background: #2dd4aa;
    }
    
    .button.warning {
      background: #f59e0b;
      color: #000000;
    }
    
    .button.warning:hover {
      background: #d97706;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .button-row .button {
      flex: 1;
      margin-bottom: 0;
    }
    
    .button.import {
      background: #06b6d4;
      color: #000000;
    }
    
    .button.import:hover {
      background: #0891b2;
    }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .status.success {
      background: #3ecf8e20;
      color: #3ecf8e;
      border: 1px solid #3ecf8e40;
    }
    
    .status.error {
      background: #ef444420;
      color: #ef4444;
      border: 1px solid #ef444440;
    }
    
    .status.info {
      background: #06b6d420;
      color: #06b6d4;
      border: 1px solid #06b6d440;
    }
    
    .status.warning {
      background: #f59e0b20;
      color: #f59e0b;
      border: 1px solid #f59e0b40;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      font-size: 12px;
      margin-bottom: 10px;
      color: #cccccc;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-dot.connected {
      background: #3ecf8e;
    }
    
    .status-dot.disconnected {
      background: #ef4444;
    }
    
    .status-dot.warning {
      background: #f59e0b;
    }
    
    .token-stats {
      display: flex;
      justify-content: space-between;
      background: #3a3a3a;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 11px;
      border: 1px solid #4a4a4a;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-weight: 600;
      font-size: 14px;
      color: #3ecf8e;
    }
    
    .stat-label {
      color: #cccccc;
      margin-top: 2px;
    }
    
    .changes-summary {
      background: #f59e0b20;
      border: 1px solid #f59e0b40;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    .changes-summary h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #f59e0b;
    }
    
    .change-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      color: #cccccc;
    }
    
    .hidden {
      display: none;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .button-minimal {
      background: transparent;
      border: 1px solid #4a4a4a;
      color: #cccccc;
      padding: 12px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-height: 60px;
    }
    
    .button-minimal:hover:not(:disabled) {
      background: #3a3a3a;
      border-color: #3ecf8e;
      color: #ffffff;
    }
    
    .button-minimal:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .auth-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .api-key-input {
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2c2c2c;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
    }

    .api-key-input:focus {
      outline: none;
      border-color: #3ecf8e;
    }

    .button-group {
      display: flex;
      gap: 8px;
    }

    .auth-status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
    }

    .auth-status.success {
      background: rgba(62, 207, 142, 0.1);
      color: #3ecf8e;
      border: 1px solid rgba(62, 207, 142, 0.3);
    }

    .auth-status.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .button-icon {
      font-size: 16px;
      line-height: 1;
    }
    
    .button-text {
      font-size: 10px;
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
    }
    
    .collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible:hover {
      background: #4a4a4a;
    }
    
    .config-form {
      display: none;
    }
    
    .config-form.active {
      display: block;
    }
    
    .toggle-text {
      font-size: 11px;
      color: #cccccc;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <svg width="20" height="18" viewBox="0 0 26 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
        <path d="M21.5097 13.1826C22.7135 13.1826 23.3068 14.6466 22.4426 15.4847L14.48 23.2069C13.9556 23.7155 13.2538 23.9999 12.5233 23.9999H3.30663C2.10283 23.9999 1.50953 22.536 2.37369 21.6979L10.3363 13.9756C10.8607 13.467 11.5625 13.1826 12.293 13.1826H21.5097Z" fill="#3ECF8E" fill-opacity="0.8"/>
        <path d="M21.7714 6.47949C22.9752 6.47949 23.5685 7.94347 22.7043 8.78154L14.8592 16.3898C14.2595 16.9715 13.4568 17.2968 12.6213 17.2968H3.56835C2.36455 17.2968 1.77125 15.8328 2.63541 14.9948L10.598 7.27249C11.1224 6.76391 11.8242 6.47949 12.5547 6.47949H21.7714Z" fill="#3ECF8E" fill-opacity="0.8"/>
        <path d="M21.5097 4.02872e-07C22.7135 4.55492e-07 23.3068 1.46398 22.4426 2.30205L14.48 10.0243C13.9556 10.5329 13.2538 10.8173 12.5233 10.8173H3.30663C2.10283 10.8173 1.50953 9.35334 2.37369 8.51527L10.3363 0.793002C10.8607 0.284423 11.5625 -3.1932e-08 12.293 0L21.5097 4.02872e-07Z" fill="#3ECF8E" fill-opacity="0.8"/>
      </svg>
      Fragmento Sync
    </h1>
    
    <!-- Authentication -->
    <div class="section">
      <h2>Authentication</h2>
      <div class="auth-container">
        <input type="password" id="apiKeyInput" placeholder="Enter your API key" class="api-key-input" />
        <div class="button-group">
          <button class="button-minimal" id="saveApiKeyBtn">
            <span class="button-icon">üîë</span>
            <span class="button-text">Save Key</span>
          </button>
          <button class="button-minimal" id="clearApiKeyBtn">
            <span class="button-icon">üóëÔ∏è</span>
            <span class="button-text">Clear Key</span>
          </button>
        </div>
      </div>
      <div class="auth-status hidden" id="authStatus"></div>
    </div>

    <!-- Connection Status -->
    <div class="section">
      <div class="connection-status">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Checking connection...</span>
        </div>
        <div class="connection-details hidden" id="connectionDetails"></div>
      </div>
    </div>
    <!-- Token Statistics -->
    <div class="section" id="statsSection" style="display: none;">
      <h2>Token Overview</h2>
      <div class="token-stats">
        <div class="stat-item">
          <div class="stat-number" id="totalTokens">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="addedTokens">0</div>
          <div class="stat-label">Added</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="modifiedTokens">0</div>
          <div class="stat-label">Modified</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="deletedTokens">0</div>
          <div class="stat-label">Deleted</div>
        </div>
      </div>
    </div>
    
    <!-- Changes Summary -->
    <div id="changesSummary" class="changes-summary hidden">
      <h3>üìã Detected Changes</h3>
      <div id="changesContent"></div>
    </div>
    
    <!-- Actions -->
    <div class="section">
      <h2>Actions</h2>
      <div class="action-grid">
        <button class="button-minimal" id="fetchBtn">
          <span class="button-icon">üì•</span>
          <span class="button-text">Fetch Tokens</span>
        </button>
        <button class="button-minimal" id="checkChangesBtn" disabled>
          <span class="button-icon">üîç</span>
          <span class="button-text">Check Changes</span>
        </button>
        <button class="button-minimal" id="importBtn" disabled>
          <span class="button-icon">üöÄ</span>
          <span class="button-text">Import All</span>
        </button>
        <button class="button-minimal" id="variablesBtn" disabled>
          <span class="button-icon">üìê</span>
          <span class="button-text">Create Variables</span>
        </button>
        <button class="button-minimal" id="pushBtn" disabled>
          <span class="button-icon">üì§</span>
          <span class="button-text">Push to App</span>
        </button>
      </div>
    </div>
    
    <!-- Status Messages -->
    <div id="statusMessage"></div>
    
    <!-- Close -->
    <div class="section">
      <button class="button secondary" id="closeBtn">Close Plugin</button>
    </div>
  </div>

  <script>
    let tokens = [];
    let currentChanges = null;
    let isSupabaseConfigured = false;
    
    // DOM elements
    const fetchBtn = document.getElementById('fetchBtn');
    const checkChangesBtn = document.getElementById('checkChangesBtn');
    const importBtn = document.getElementById('importBtn');
    const variablesBtn = document.getElementById('variablesBtn');
    const pushBtn = document.getElementById('pushBtn');
    const closeBtn = document.getElementById('closeBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const connectionDetails = document.getElementById('connectionDetails');
    const statsSection = document.getElementById('statsSection');
    const changesSummary = document.getElementById('changesSummary');
    const changesContent = document.getElementById('changesContent');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
    const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
    const authStatus = document.getElementById('authStatus');
    
    // Event listeners
    fetchBtn.addEventListener('click', fetchTokens);
    checkChangesBtn.addEventListener('click', checkChanges);
    importBtn.addEventListener('click', importTokens);
    variablesBtn.addEventListener('click', createVariablesOnly);
    pushBtn.addEventListener('click', pushVariablesToApp);
    closeBtn.addEventListener('click', closePlugin);
    saveApiKeyBtn.addEventListener('click', saveApiKey);
    clearApiKeyBtn.addEventListener('click', clearApiKey);
    
    
    // Fetch tokens
    function fetchTokens() {
      showStatus('Fetching tokens...', 'info');
      fetchBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'fetch-tokens' } }, '*');
    }
    
    // Check for changes
    function checkChanges() {
      showStatus('Checking for changes...', 'info');
      checkChangesBtn.disabled = true;
      
      parent.postMessage({ pluginMessage: { type: 'check-changes' } }, '*');
    }
    
    
    // Import all tokens (variables + visualization)
    function importTokens() {
      if (tokens.length === 0) {
        showStatus('No tokens to import', 'error');
        return;
      }
      
      showStatus('Creating variables and visualization...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'import-tokens', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Create variables only
    function createVariablesOnly() {
      if (tokens.length === 0) {
        showStatus('No tokens to create variables from', 'error');
        return;
      }
      
      showStatus('Creating Figma variables...', 'info');
      importBtn.disabled = true;
      variablesBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables-only', 
          tokens: tokens 
        } 
      }, '*');
    }
    
    // Push variables to app
    function pushVariablesToApp() {
      showStatus('Reading Figma variables...', 'info');
      pushBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'push-variables-to-app'
        } 
      }, '*');
    }
    
    // API Key management
    async function saveApiKey() {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showAuthStatus('Please enter an API key', 'error');
        return;
      }

      try {
        // Test the API key by making a request
        const response = await fetch('https://design-token-management-app.vercel.app/api/tokens', {
          method: 'GET',
          headers: {
            'X-API-Key': apiKey,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // Store API key in plugin storage
          parent.postMessage({ 
            pluginMessage: { 
              type: 'save-api-key', 
              apiKey: apiKey 
            } 
          }, '*');
          
          showAuthStatus('API key saved and validated successfully', 'success');
          apiKeyInput.value = ''; // Clear input for security
        } else if (response.status === 401) {
          showAuthStatus('Invalid API key - not found in database. Generate a new key in the web app Settings.', 'error');
        } else {
          showAuthStatus('Invalid API key - please check and try again', 'error');
        }
      } catch (error) {
        showAuthStatus('Failed to validate API key: ' + error.message, 'error');
      }
    }

    async function clearApiKey() {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'clear-api-key'
        } 
      }, '*');
      
      showAuthStatus('API key cleared', 'success');
      apiKeyInput.value = '';
    }

    function showAuthStatus(message, type) {
      authStatus.textContent = message;
      authStatus.className = `auth-status ${type}`;
      authStatus.classList.remove('hidden');
      
      // Hide after 3 seconds
      setTimeout(() => {
        authStatus.classList.add('hidden');
      }, 3000);
    }

    // Close plugin
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }
    
    // Show status message
    function showStatus(message, type = 'info') {
      statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Update connection status
    function updateConnectionStatus(connected, details = '', type = 'info') {
      const dotClass = type === 'warning' ? 'warning' : (connected ? 'connected' : 'disconnected');
      statusDot.className = `status-dot ${dotClass}`;
      
      if (isSupabaseConfigured) {
        statusText.textContent = connected ? 'Connected to Supabase' : 'Supabase connection failed';
      } else {
        statusText.textContent = connected ? 'Connected via API' : 'Not connected';
      }
      
      if (details) {
        connectionDetails.textContent = details;
        connectionDetails.classList.remove('hidden');
      } else {
        connectionDetails.classList.add('hidden');
      }
    }
    
    // Update token statistics
    function updateStats(totalTokens, changes = null) {
      document.getElementById('totalTokens').textContent = totalTokens;
      
      if (changes) {
        document.getElementById('addedTokens').textContent = changes.added.length;
        document.getElementById('modifiedTokens').textContent = changes.modified.length;
        document.getElementById('deletedTokens').textContent = changes.deleted.length;
      } else {
        document.getElementById('addedTokens').textContent = '0';
        document.getElementById('modifiedTokens').textContent = '0';
        document.getElementById('deletedTokens').textContent = '0';
      }
      
      statsSection.style.display = 'block';
    }
    
    // Update changes summary
    function updateChangesSummary(changes) {
      if (!changes || (changes.added.length === 0 && changes.modified.length === 0 && changes.deleted.length === 0)) {
        changesSummary.classList.add('hidden');
        return;
      }
      
      let html = '';
      
      if (changes.added.length > 0) {
        html += `<div class="change-item"><span>‚ûï Added:</span><span>${changes.added.length}</span></div>`;
      }
      
      if (changes.modified.length > 0) {
        html += `<div class="change-item"><span>‚úèÔ∏è Modified:</span><span>${changes.modified.length}</span></div>`;
      }
      
      if (changes.deleted.length > 0) {
        html += `<div class="change-item"><span>üóëÔ∏è Deleted:</span><span>${changes.deleted.length}</span></div>`;
      }
      
      changesContent.innerHTML = html;
      changesSummary.classList.remove('hidden');
    }
    
    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'plugin-ready') {
        showStatus('Plugin ready', 'info');
      }
      
      if (msg.type === 'supabase-auto-configured') {
        if (msg.success) {
          showStatus('Connected to Supabase automatically', 'success');
          updateConnectionStatus(true, 'Supabase connection active');
        } else {
          showStatus('Using API fallback mode', 'info');
          updateConnectionStatus(true, 'API fallback active');
        }
      }
      
      if (msg.type === 'supabase-configured') {
        if (msg.success) {
          isSupabaseConfigured = true;
          showStatus(`Supabase connected! Found ${msg.tokenCount} tokens`, 'success');
          updateConnectionStatus(true, `${msg.tokenCount} tokens available`, 'success');
        } else {
          showStatus(`Supabase connection failed: ${msg.error}`, 'error');
          updateConnectionStatus(false, msg.error, 'error');
        }
      }
      
      if (msg.type === 'tokens-fetched') {
        tokens = msg.tokens || [];
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = tokens.length === 0;
        variablesBtn.disabled = tokens.length === 0;
        
        // Enable push button - it works independently of fetched tokens
        pushBtn.disabled = false;
        
        updateConnectionStatus(true, `${tokens.length} tokens loaded`);
        updateStats(tokens.length);
        showStatus(`Fetched ${tokens.length} tokens successfully`, 'success');
      }
      
      if (msg.type === 'changes-detected') {
        currentChanges = msg.changes;
        checkChangesBtn.disabled = false;
        
        updateStats(msg.totalTokens, msg.changes);
        updateChangesSummary(msg.changes);
        
        const changeCount = (msg.changes.added.length + msg.changes.modified.length + msg.changes.deleted.length);
        if (changeCount > 0) {
          showStatus(`Found ${changeCount} changes`, 'warning');
        } else {
          showStatus('No changes detected', 'success');
        }
      }
      
      
      if (msg.type === 'success') {
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        pushBtn.disabled = false;
        showStatus(msg.message, 'success');
      }
      
      if (msg.type === 'error') {
        fetchBtn.disabled = false;
        checkChangesBtn.disabled = false;
        importBtn.disabled = false;
        variablesBtn.disabled = false;
        pushBtn.disabled = false;
        updateConnectionStatus(false, msg.error || msg.message);
        showStatus(msg.error || msg.message, 'error');
      }
    };
    
    // Initialize and check for existing Figma variables
    function initializePlugin() {
      // Enable push button immediately since it works with existing Figma variables
      pushBtn.disabled = false;
      showStatus('Ready to connect', 'info');
    }
    
    // Initialize
    initializePlugin();
  </script>
</body>
</html>
